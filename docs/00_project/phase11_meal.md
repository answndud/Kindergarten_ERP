# Phase 11: 식단 관리 (Meal/Food Menu)

## 개요
- 단계: 식단 관리 시스템 구현
- 목표: 주간 식단표 등록/조회, 알레르기 정보 표시, 영양 정보 관리
- 작업: MealMenu, AllergyInfo 도메인

---

## 1. MealMenu 엔티티 설계

### 결정
일별 식단을 별도 엔티티로 관리 (아침/점심/저녁/간식 구분)

### 이유
1. **일별 관리**: 날짜별로 식단을 명확히 구분
2. **끼니 구분**: 아침, 점심, 저녁, 간식 별도 관리
3. **알레르기 연동**: 메뉴별 알레르기 유발 식재료 표시

### 관계 설계
```
Kindergarten (1:N) MealMenu
```

### 주요 필드
- `menuDate`: 식단 날짜
- `mealType`: 끼니 유형 (BREAKFAST, LUNCH, DINNER, SNACK)
- `mainMenu`: 주 메뉴 (ex: 잡곡밥, 된장찌개)
- `sideMenus`: 반찬 목록 (JSON 또는 별도 테이블)
- `specialNote`: 특이사항 (ex: 생일 특식)
- `calories`: 칼로리
- `imageUrl`: 식단 사진

### 변경 이력
- 2026-02-13: MealMenu 엔티티 설계 결정

---

## 2. 끼니 유형 (MealType) 설계

### 결정
4가지 끼니 유형으로 구분

### 유형 목록
```java
public enum MealType {
    BREAKFAST,  // 아침
    LUNCH,      // 점심
    DINNER,     // 저녁
    SNACK       // 간식
}
```

### 노출 우선순위
- **유치원**: LUNCH, SNACK (점심, 간식 위주)
- **어린이집**: BREAKFAST, LUNCH, DINNER, SNACK (전체)

### 변경 이력
- 2026-02-13: 4가지 끼니 유형 결정

---

## 3. 알레르기 정보 설계

### 결정
알레르기 유발 식재료를 별도 관리하고 메뉴와 연동

### 알레르기 식재료 목록
```java
public enum Allergen {
    EGG,           // 계란
    MILK,          // 우유
    WHEAT,         // 밀
    SOYBEAN,       // 대두
    PEANUT,        // 땅콩
    WALNUT,        // 호두
    PINE_NUT,      // 잣
    BUCKWHEAT,     // 메밀
    CRAB,          // 게
    SHRIMP,        // 새우
    SQUID,         // 오징어
    MACKEREL,      // 고등어
    SHELLFISH,     // 조개류
    PEACH,         // 복숭아
    TOMATO,        // 토마토
    SULFITE,       // 아황산류
    PORK,          // 돼지고기
    CHICKEN,       // 닭고기
    BEEF,          // 소고기
    NONE           // 없음
}
```

### 구현 방식
```java
// MealMenu 엔티티에 알레르기 정보 저장
@Column(name = "allergens")
@Convert(converter = AllergenListConverter.class)
private List<Allergen> allergens;
```

### 알레르기 표시
- 메뉴 표시 시 알레르기 아이콘 표시
- 학부모는 자녀 알레르기 설정 가능
- 자녀 알레르기와 일치하는 식재료 강조 표시

### 변경 이력
- 2026-02-13: 19가지 알레르기 식재료 결정

---

## 4. API 설계

### 결정
RESTful API 설계

### 식단 API
| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| GET | /api/v1/meals | 식단 목록 조회 (주간/월간) |
| GET | /api/v1/meals/{id} | 식단 상세 조회 |
| GET | /api/v1/meals/date/{date} | 특정 날짜 식단 조회 |
| POST | /api/v1/meals | 식단 등록 |
| PUT | /api/v1/meals/{id} | 식단 수정 |
| DELETE | /api/v1/meals/{id} | 식단 삭제 |
| GET | /api/v1/meals/today | 오늘의 식단 |
| GET | /api/v1/meals/week | 이번 주 식단 |

### 알레르기 API
| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| GET | /api/v1/allergens | 알레르기 목록 조회 |
| GET | /api/v1/kids/{kidId}/allergens | 원생 알레르기 조회 |
| PUT | /api/v1/kids/{kidId}/allergens | 원생 알레르기 설정 |

### 변경 이력
- 2026-02-13: RESTful API 설계

---

## 5. 주간 식단표 UI 설계

### 결정
주간 캘린더 형태의 식단표 + 일별 상세

### 화면 구성
1. **주간 식단표**: 월~금 식단을 한눈에 (점심/간식 중심)
2. **일별 상세**: 클릭 시 상세 메뉴와 알레르기 정보
3. **알레르기 강조**: 자녀 알레르기와 일치하는 식재료 하이라이트
4. **사진 표시**: 실제 제공된 식단 사진

### 테이블 구조
```
| 시간 | 월 | 화 | 수 | 목 | 금 |
|------|---|---|---|---|---|
| 아침 |   |   |   |   |   |
| 점심 |   |   |   |   |   |
| 간식 |   |   |   |   |   |
| 저녁 |   |   |   |   |   |
```

### 변경 이력
- 2026-02-13: 주간 캘린더 형태 식단표 결정

---

## 6. 식단 등록 UI 설계

### 결정
날짜 범위 선택 + 끼니별 입력 폼

### 입력 항목
- 날짜 범위 (시작일 ~ 종료일)
- 끼니 선택 (아침/점심/저녁/간식)
- 주 메뉴 입력
- 반찬 목록 입력 (콤마 또는 개행 구분)
- 알레르기 식재료 선택 (체크박스)
- 특이사항
- 칼로리
- 사진 업로드 (선택)

### 벌크 등록
- 한 주 전체 식단 한 번에 등록
- 템플릿 저장/불러오기 기능

### 변경 이력
- 2026-02-13: 벌크 등록 지원 결정

---

## 7. 알림 연동

### 결정
식단 등록/수정 시 알림 발송

### 알림 시점
- 식단 등록 시: 해당 유치원 학부모에게 알림
- 식단 수정 시: 변경된 날짜의 학부모에게 알림
- 전날 저녁: 다음 날 식단 미리보기 알림

### 알림 타입
```java
MEAL_MENU_REGISTERED    // 식단 등록 알림
MEAL_MENU_UPDATED       // 식단 수정 알림
MEAL_TOMORROW_PREVIEW   // 내일 식단 미리보기
```

### 변경 이력
- 2026-02-13: Phase 8 알림 시스템과 연동 결정

---

## 8. 권한 제어

### 결정
원장/교사만 식단 등록/수정 가능

### 권한 규칙
| 기능 | PRINCIPAL | TEACHER | PARENT |
|------|-----------|---------|--------|
| 식단 등록 | O | O | X |
| 식단 수정 | O | O | X |
| 식단 조회 | O | O | O |
| 알레르기 설정 | O | O | 자녀만 |

### 변경 이력
- 2026-02-13: 권한 규칙 결정

---

## 면접 예상 질문 답변

### Q: 알레르기 정보는 어떻게 관리하나요?
> A: 19가지 알레르기 유발 식재료를 enum으로 정의하고, 식단에 포함된 알레르기 식재료를 리스트로 저장합니다. 학부모는 자녀의 알레르기를 설정할 수 있고, 식단 조회 시 자녀 알레르기와 일치하는 식재료를 아이콘이나 색상으로 강조 표시합니다.

### Q: 식단은 누가 등록하나요?
> A: 원장과 교사가 등록할 수 있습니다. 보통은 원장이나 행정 담당 교사가 한 주 단위로 등록하며, 벌크 등록 기능을 통해 한 번에 여러 날짜의 식단을 등록할 수 있습니다.

### Q: 식단 알림은 어떻게 발송되나요?
> A: 식단이 등록되거나 수정되면 해당 유치원 학부모들에게 알림이 발송됩니다. 또한 전날 저녁에는 다음 날 식단 미리보기 알림을 발송해서 아침에 확인하지 못한 학부모도 알 수 있게 합니다.

---

## 구현 체크리스트

### 백엔드
- [ ] MealMenu 엔티티 생성
- [ ] Allergen enum 생성
- [ ] MealMenuRepository 생성
- [ ] DTO (Request/Response) 생성
- [ ] MealMenuService 구현
- [ ] MealMenuController 구현
- [ ] 원생 알레르기 설정 API 구현

### 프론트엔드
- [ ] 식단 페이지 (/meals) 생성
- [ ] 주간 식단표 UI 구현
- [ ] 일별 식단 상세 모달 구현
- [ ] 식단 등록/수정 폼 구현
- [ ] 알레르기 아이콘 표시 구현
- [ ] HTMX 부분 갱신 구현

### DB 마이그레이션
- [ ] meal_menus 테이블 생성 (Flyway)
- [ ] kids 테이블에 allergens 컬럼 추가

---

## 다음 단계
Phase 12: 출석 통계/리포트 구현

---

**Phase 11 설계일: 2026-02-13**
