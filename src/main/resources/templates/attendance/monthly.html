<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출석 월간 리포트 - 유치원 ERP</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#F3FBF7',
                            100: '#E2F5EB',
                            200: '#C7EBD9',
                            300: '#A4DEC2',
                            400: '#79CCA5',
                            500: '#56B88C',
                            600: '#3F9C73',
                            700: '#327D5E',
                            800: '#26624A',
                            900: '#1D4D3A',
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .bg-gradient-primary { background: linear-gradient(135deg, #56B88C 0%, #3F9C73 100%); }
    </style>
    <link rel="stylesheet" th:href="@{/css/custom.css}" href="/css/custom.css">
</head>
<body class="bg-gray-50">

<header th:replace="~{fragments/header :: header}"></header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col gap-2 mb-6">
        <h1 class="text-2xl font-bold text-gray-900">월간 출석 리포트</h1>
        <p class="text-gray-600">반별 원생 출석 통계를 월 단위로 확인하세요.</p>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6" x-data="monthlyReport()" x-init="init()">
        <div class="grid gap-4 md:grid-cols-3">
            <div>
                <label for="monthPicker" class="block text-sm font-medium text-gray-700 mb-1">월 선택</label>
                <input type="month" id="monthPicker" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
            </div>
            <div>
                <label for="classroomSelect" class="block text-sm font-medium text-gray-700 mb-1">반 선택</label>
                <select id="classroomSelect" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="">반을 선택하세요</option>
                    <template x-for="classroom in classrooms" :key="classroom.id">
                        <option :value="classroom.id" x-text="classroom.name"></option>
                    </template>
                </select>
            </div>
            <div class="flex items-end">
                <button type="button" class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 transition-colors" onclick="loadMonthlyReport()">
                    리포트 조회
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900" id="reportTitle">반별 리포트</h2>
                <p class="text-sm text-gray-500" id="reportSubtitle">반과 월을 선택해 주세요.</p>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">원생</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">출석</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">결석</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">지각</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">조퇴</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">병결</th>
                    <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">총 기록</th>
                </tr>
                </thead>
                <tbody id="monthlyReportBody" class="divide-y divide-gray-200">
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">조회할 리포트를 선택해 주세요.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/js/app.js}"></script>

<script>
    function monthlyReport() {
        return {
            classrooms: [],
            async init() {
                const monthPicker = document.getElementById('monthPicker');
                const today = new Date();
                const monthValue = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                monthPicker.value = monthValue;

                try {
                    const res = await fetch('/api/v1/members/me', { credentials: 'same-origin' });
                    if (!res.ok) return;
                    const me = await res.json().catch(() => ({}));
                    if (!me.success || !me.data) return;
                    const kindergartenId = me.data.kindergartenId;
                    if (!kindergartenId) return;

                    const classroomsRes = await fetch(`/api/v1/classrooms?kindergartenId=${kindergartenId}`, { credentials: 'same-origin' });
                    if (classroomsRes.ok) {
                        const data = await classroomsRes.json().catch(() => ({}));
                        this.classrooms = Array.isArray(data.data) ? data.data : (data.data?.content || []);

                        if (this.classrooms.length > 0) {
                            requestAnimationFrame(() => {
                                const select = document.getElementById('classroomSelect');
                                if (select && !select.value) {
                                    select.value = String(this.classrooms[0].id);
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.error('Error loading classrooms:', e);
                }
            }
        };
    }

    async function loadMonthlyReport() {
        const monthPicker = document.getElementById('monthPicker').value;
        const classroomId = document.getElementById('classroomSelect').value;
        const body = document.getElementById('monthlyReportBody');
        const title = document.getElementById('reportTitle');
        const subtitle = document.getElementById('reportSubtitle');

        if (!monthPicker || !classroomId) {
            body.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">반과 월을 선택해 주세요.</td></tr>';
            return;
        }

        const [year, month] = monthPicker.split('-').map(Number);

        try {
            const response = await fetch(`/api/v1/attendance/classroom/${classroomId}/monthly-report?year=${year}&month=${month}`, {
                credentials: 'same-origin'
            });
            const data = await response.json().catch(() => ({}));
            if (!data.success || !data.data) {
                body.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">리포트를 불러올 수 없습니다.</td></tr>';
                return;
            }

            const report = data.data;
            title.textContent = `${report.classroomName} 출석 리포트`;
            subtitle.textContent = `${report.year}년 ${String(report.month).padStart(2, '0')}월 기준`;

            if (!report.kids || report.kids.length === 0) {
                body.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">표시할 데이터가 없습니다.</td></tr>';
                return;
            }

            body.innerHTML = report.kids.map(kid => {
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-gray-900 font-medium">${kid.kidName}</td>
                        <td class="px-6 py-4 text-center text-gray-700">${kid.presentDays}</td>
                        <td class="px-6 py-4 text-center text-gray-700">${kid.absentDays}</td>
                        <td class="px-6 py-4 text-center text-gray-700">${kid.lateDays}</td>
                        <td class="px-6 py-4 text-center text-gray-700">${kid.earlyLeaveDays}</td>
                        <td class="px-6 py-4 text-center text-gray-700">${kid.sickLeaveDays}</td>
                        <td class="px-6 py-4 text-center text-gray-700">${kid.totalDays}</td>
                    </tr>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading report:', error);
            body.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">리포트 로드 중 오류가 발생했습니다.</td></tr>';
        }
    }
</script>
</body>
</html>
