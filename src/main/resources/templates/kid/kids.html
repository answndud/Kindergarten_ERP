<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>원생 관리 - 유치원 ERP</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .bg-gradient-primary { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
    </style>
</head>
<body class="bg-gray-50">

<header th:replace="~{fragments/header :: header}"></header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">원생 관리</h1>
        <p class="text-gray-600">
            <span th:if="${currentMember?.kindergartenName != null}">
                <span class="font-medium" th:text="${currentMember.kindergartenName}">유치원</span>의 원생을 관리합니다.
            </span>
            <span th:if="${currentMember?.kindergartenName == null}">소속 유치원이 없습니다. 먼저 승인/배정을 완료하세요.</span>
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-bold text-gray-900 mb-4">원생 검색</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">반</label>
                    <select id="classroom-filter"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">전체</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                    <input id="name-filter"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                           placeholder="이름 검색"
                           onkeydown="if (event.key === 'Enter') { event.preventDefault(); loadKids({ page: 1 }); }" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">정렬</label>
                    <select id="sort-filter"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="name">이름순</option>
                        <option value="age">나이순</option>
                        <option value="recent">최근 등록순</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="loadKids({ page: 1 })" class="flex-1 px-5 py-2.5 bg-gradient-primary text-white font-medium rounded-xl hover:shadow-lg transition-all">
                        검색
                    </button>
                    <button type="button" onclick="resetFilters()" class="px-5 py-2.5 border border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-all">
                        초기화
                    </button>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 lg:col-span-2">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-bold text-gray-900">원생 목록</h2>
                    <p class="text-xs text-gray-500 mt-1" id="kid-summary">총 0명</p>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="showCreateKidModal()" class="px-4 py-2 bg-gradient-primary text-white text-sm font-medium rounded-lg hover:shadow-lg transition-all">
                        원생 추가
                    </button>
                    <button type="button" onclick="loadKids({ page: currentPage })" class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-all">
                        새로고침
                    </button>
                </div>
            </div>

            <div id="kid-list" class="space-y-3">
                <div class="text-center py-8 text-gray-500">불러오는 중...</div>
            </div>

            <div class="mt-6 flex items-center justify-between" id="kid-pagination">
                <button type="button" id="kid-prev" class="px-3 py-2 text-sm font-medium text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50" onclick="changePage(currentPage - 1)">이전</button>
                <div class="text-sm text-gray-500" id="kid-page-indicator">1 / 1</div>
                <button type="button" id="kid-next" class="px-3 py-2 text-sm font-medium text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50" onclick="changePage(currentPage + 1)">다음</button>
            </div>
        </section>
    </div>
</main>

<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<!-- Alpine.js -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Custom JS (Notifications/UI) -->
<script th:src="@{/js/app.js}" src="/js/app.js"></script>

<script th:inline="javascript">
    const UI = window.UI || {
        alert: async ({ title = '알림', text = '' } = {}) => window.alert(text ? `${title}\n\n${text}` : title),
        success: async (message, title = '완료') => window.alert(`${title}\n\n${message}`),
        error: async (message, title = '오류') => window.alert(`${title}\n\n${message}`),
        confirm: async ({ text = '계속 진행할까요?' } = {}) => window.confirm(text)
    };
    const initialKindergartenId = /*[[${currentMember?.kindergartenId}]]*/ null;
    const currentRole = /*[[${currentMember?.role?.name()}]]*/ null;
    const isPrincipal = currentRole === 'PRINCIPAL';
    let kindergartenId = initialKindergartenId;
    let classroomsCache = [];
    let kidsCache = [];
    let currentPage = 1;
    const pageSize = 8;
    let totalPages = 1;

    async function fetchMe() {
        const response = await fetch('/api/v1/members/me', { credentials: 'same-origin' });
        if (!response.ok) return null;
        const result = await response.json().catch(() => ({}));
        return result.data || null;
    }

    async function ensureKindergartenId() {
        if (kindergartenId) return kindergartenId;
        const me = await fetchMe();
        if (me && me.kindergartenId) kindergartenId = me.kindergartenId;
        return kindergartenId;
    }

    function buildClassroomCounts(kids) {
        return (kids || []).reduce((acc, kid) => {
            const classroomId = kid.classroomId;
            if (!classroomId) return acc;
            acc[classroomId] = (acc[classroomId] || 0) + 1;
            return acc;
        }, {});
    }

    function renderClassroomOptions(select, classrooms, counts = {}) {
        if (!select) return;
        select.innerHTML = '<option value="">전체</option>' + (classrooms || [])
            .map(c => {
                const count = counts[c.id] || 0;
                return `<option value="${c.id}">${c.name} (${count}명)</option>`;
            })
            .join('');
    }

    async function ensureKidsCache(force = false) {
        const id = await ensureKindergartenId();
        if (!id) return [];
        if (kidsCache.length > 0 && !force) return kidsCache;

        const response = await fetch(`/api/v1/kids?kindergartenId=${id}`, { credentials: 'same-origin' });
        if (!response.ok) {
            kidsCache = [];
            return kidsCache;
        }

        const result = await response.json().catch(() => ({}));
        kidsCache = result.data || [];
        return kidsCache;
    }

    async function fetchKids(params) {
        const response = await fetch(`/api/v1/kids?${params}`, { credentials: 'same-origin' });
        if (!response.ok) return [];
        const result = await response.json().catch(() => ({}));
        return result.data || [];
    }

    function updatePagination(totalCount) {
        totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
        const prevBtn = document.getElementById('kid-prev');
        const nextBtn = document.getElementById('kid-next');
        const indicator = document.getElementById('kid-page-indicator');

        if (prevBtn) prevBtn.disabled = currentPage <= 1;
        if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        if (indicator) indicator.textContent = `${currentPage} / ${totalPages}`;

        if (prevBtn) {
            prevBtn.classList.toggle('opacity-40', currentPage <= 1);
            prevBtn.classList.toggle('cursor-not-allowed', currentPage <= 1);
        }
        if (nextBtn) {
            nextBtn.classList.toggle('opacity-40', currentPage >= totalPages);
            nextBtn.classList.toggle('cursor-not-allowed', currentPage >= totalPages);
        }

        const summary = document.getElementById('kid-summary');
        if (summary) summary.textContent = `총 ${totalCount}명`;
    }

    function changePage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        loadKids({ page: currentPage });
    }

    function sortKids(kids, sortKey) {
        const list = [...kids];
        if (sortKey === 'age') {
            return list.sort((a, b) => (b.age || 0) - (a.age || 0));
        }
        if (sortKey === 'recent') {
            return list.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }
        return list.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''), 'ko'));
    }

    async function loadClassrooms() {
        const id = await ensureKindergartenId();
        const select = document.getElementById('classroom-filter');

        if (!id) {
            select.innerHTML = '<option value="">소속 유치원 없음</option>';
            return;
        }

        const response = await fetch(`/api/v1/classrooms?kindergartenId=${id}`, { credentials: 'same-origin' });
        if (!response.ok) {
            select.innerHTML = '<option value="">반 목록 로드 실패</option>';
            return;
        }

        const result = await response.json().catch(() => ({}));
        classroomsCache = result.data || [];

        const counts = buildClassroomCounts(kidsCache);
        renderClassroomOptions(select, classroomsCache, counts);
    }

    async function loadKids({ refreshCounts = false, page = currentPage } = {}) {
        const id = await ensureKindergartenId();
        const container = document.getElementById('kid-list');
        const classroomId = document.getElementById('classroom-filter').value;
        const name = document.getElementById('name-filter').value;
        const sortKey = document.getElementById('sort-filter').value || 'name';

        if (!id) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">소속 유치원이 없어 원생 목록을 불러올 수 없습니다.</div>';
            updatePagination(0);
            return;
        }

        const params = new URLSearchParams({ kindergartenId: id });
        if (classroomId) params.append('classroomId', classroomId);
        if (name) params.append('name', name.trim());

        const [kids] = await Promise.all([
            fetchKids(params),
            refreshCounts || (!classroomId && !name) ? ensureKidsCache(true) : ensureKidsCache()
        ]);

        const counts = buildClassroomCounts(kidsCache);
        if (classroomsCache.length > 0) {
            renderClassroomOptions(document.getElementById('classroom-filter'), classroomsCache, counts);
        }

        if (!kids.length) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">원생이 없습니다.</div>';
            updatePagination(0);
            return;
        }

        const sortedKids = sortKids(kids, sortKey);
        const totalCount = sortedKids.length;
        currentPage = Math.min(Math.max(page, 1), Math.max(1, Math.ceil(totalCount / pageSize)));
        const startIndex = (currentPage - 1) * pageSize;
        const pagedKids = sortedKids.slice(startIndex, startIndex + pageSize);

        updatePagination(totalCount);

        container.innerHTML = pagedKids.map(k => {
            const age = k.age ? `(${k.age}세)` : '';
            const changeClassroomButton = isPrincipal
                ? `<button type="button" data-id="${k.id}" data-name="${k.name}" data-classroom-id="${k.classroomId}" onclick="openChangeClassroom(this)" class="px-3 py-1.5 text-sm bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all">반 변경</button>`
                : '';

            return `
                <div class="border border-gray-200 rounded-xl p-4 flex items-center justify-between">
                    <div>
                        <div class="font-semibold text-gray-900">${k.name} ${age}</div>
                        <div class="mt-1 text-sm text-gray-600">
                            ${k.birthDate} · ${k.gender === 'MALE' ? '남' : '여'}
                        </div>
                        <div class="text-sm text-primary-700">${k.classroomName || '반 미배정'}</div>
                    </div>
                    <div class="flex gap-2">
                        ${changeClassroomButton}
                        <button type="button" onclick="showParentManageModal(${k.id})" class="px-3 py-1.5 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all">
                            학부모 관리
                        </button>
                        <button type="button" onclick="showEditKidModal(${k.id})" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all">
                            편집
                        </button>
                        <button type="button" data-id="${k.id}" data-name="${k.name}" onclick="openDeleteKid(this)" class="px-3 py-1.5 text-sm bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all">
                            삭제
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function resetFilters() {
        document.getElementById('classroom-filter').value = '';
        document.getElementById('name-filter').value = '';
        document.getElementById('sort-filter').value = 'name';
        currentPage = 1;
        loadKids({ page: 1 });
    }

    function openDeleteKid(button) {
        const kidId = Number(button.dataset.id);
        const kidName = button.dataset.name || '원생';
        deleteKid(kidId, kidName);
    }

    function openChangeClassroom(button) {
        const kidId = Number(button.dataset.id);
        const kidName = button.dataset.name || '원생';
        const classroomId = Number(button.dataset.classroomId || 0);
        showChangeClassroomModal(kidId, kidName, classroomId);
    }

    async function showChangeClassroomModal(kidId, kidName, currentClassroomId) {
        if (!isPrincipal) {
            await UI.alert({ title: '권한 없음', text: '반 변경은 원장만 할 수 있습니다.', icon: 'info' });
            return;
        }

        if (!classroomsCache.length) {
            await loadClassrooms();
        }

        if (!classroomsCache.length) {
            await UI.alert({ title: '반 없음', text: '반을 먼저 생성해 주세요.', icon: 'info' });
            return;
        }

        const result = await window.Swal.fire({
            title: '반 변경',
            html: `
                <div class="text-left space-y-4 mt-4">
                    <div class="text-sm text-gray-600">${kidName} 원생의 반을 변경합니다.</div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">배정할 반 *</label>
                        <select id="change-classroom-select"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        </select>
                    </div>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            cancelButtonText: '취소',
            confirmButtonText: '변경',
            customClass: {
                popup: 'rounded-2xl',
                confirmButton: 'bg-gradient-primary hover:shadow-lg transition-all',
                cancelButton: 'border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all'
            },
            didOpen: () => {
                const select = document.getElementById('change-classroom-select');
                select.innerHTML = classroomsCache
                    .map(c => `<option value="${c.id}">${c.name}</option>`)
                    .join('');
                if (currentClassroomId) {
                    select.value = String(currentClassroomId);
                }
            },
            preConfirm: () => {
                const selectedId = document.getElementById('change-classroom-select').value;
                if (!selectedId) {
                    UI.error('반을 선택해주세요.');
                    return false;
                }
                return { classroomId: selectedId };
            }
        });

        if (!result.isConfirmed || !result.value) return;

        const response = await fetch(`/api/v1/kids/${kidId}/classroom`, {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ classroomId: Number(result.value.classroomId) })
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            await UI.error(payload.message || '반 변경에 실패했습니다.');
            return;
        }

        await UI.success('반이 변경되었습니다.');
        kidsCache = [];
        await loadKids({ refreshCounts: true, page: currentPage });
    }

    async function showCreateKidModal() {
        const id = await ensureKindergartenId();
        if (!id) {
            await UI.alert({
                title: '소속 유치원이 필요해요',
                text: '원생을 추가하려면 먼저 유치원 소속이 필요합니다.',
                icon: 'info'
            });
            return;
        }

        const result = await window.Swal.fire({
            title: '원생 추가',
            html: `
                <form id="create-kid-form" class="text-left space-y-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">이름 *</label>
                        <input id="kid-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                               placeholder="이름을 입력하세요" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">생년월일 *</label>
                        <input id="kid-birthdate" type="date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">성별 *</label>
                        <select id="kid-gender" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="">선택</option>
                            <option value="MALE">남</option>
                            <option value="FEMALE">여</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">입소일 *</label>
                        <input id="kid-admission-date" type="date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">반 *</label>
                        <select id="kid-classroom" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="">선택</option>
                        </select>
                    </div>
                </form>
            `,
            focusConfirm: false,
            showCancelButton: true,
            cancelButtonText: '취소',
            confirmButtonText: '추가',
            customClass: {
                popup: 'rounded-2xl',
                confirmButton: 'bg-gradient-primary hover:shadow-lg transition-all',
                cancelButton: 'border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all'
            },
            didOpen: async () => {
                const classroomSelect = document.getElementById('kid-classroom');
                const response = await fetch(`/api/v1/classrooms?kindergartenId=${id}`, { credentials: 'same-origin' });
                if (response.ok) {
                    const payload = await response.json().catch(() => ({}));
                    const classrooms = payload.data || [];
                    classroomSelect.innerHTML = '<option value="">선택</option>' + classrooms
                        .map(c => `<option value="${c.id}">${c.name}</option>`)
                        .join('');
                }

                document.getElementById('kid-admission-date').valueAsDate = new Date();
            },
            preConfirm: () => {
                const name = document.getElementById('kid-name').value;
                const birthDate = document.getElementById('kid-birthdate').value;
                const gender = document.getElementById('kid-gender').value;
                const admissionDate = document.getElementById('kid-admission-date').value;
                const classroomId = document.getElementById('kid-classroom').value;

                if (!name || !birthDate || !gender || !admissionDate || !classroomId) {
                    UI.error('모든 필드를 입력해주세요.');
                    return false;
                }

                return { name, birthDate, gender, admissionDate, classroomId };
            }
        });

        if (!result.isConfirmed) {
            return;
        }

        const formValues = result.value;
        if (!formValues) {
            return;
        }

        const response = await fetch('/api/v1/kids', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: formValues.name,
                birthDate: formValues.birthDate,
                gender: formValues.gender,
                admissionDate: formValues.admissionDate,
                classroomId: Number(formValues.classroomId)
            })
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            await UI.error(payload.message || '원생 추가에 실패했습니다.');
            return;
        }

        await UI.success('원생이 추가되었습니다.');
        kidsCache = [];
        currentPage = 1;
        await loadKids({ refreshCounts: true, page: 1 });
        await loadClassrooms();
    }

    async function showEditKidModal(kidId) {
        const result = await window.Swal.fire({
            title: '원생 정보 수정',
            html: `
                <form id="edit-kid-form" class="text-left space-y-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">이름 *</label>
                        <input id="edit-kid-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                               placeholder="이름을 입력하세요" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">생년월일 *</label>
                        <input id="edit-kid-birthdate" type="date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">성별 *</label>
                        <select id="edit-kid-gender" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="">선택</option>
                            <option value="MALE">남</option>
                            <option value="FEMALE">여</option>
                        </select>
                    </div>
                </form>
            `,
            focusConfirm: false,
            showCancelButton: true,
            cancelButtonText: '취소',
            confirmButtonText: '수정',
            customClass: {
                popup: 'rounded-2xl',
                confirmButton: 'bg-gradient-primary hover:shadow-lg transition-all',
                cancelButton: 'border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all'
            },
            didOpen: async () => {
                const response = await fetch(`/api/v1/kids/${kidId}`, { credentials: 'same-origin' });
                if (!response.ok) return;

                const payload = await response.json().catch(() => ({}));
                const kid = payload.data;

                if (kid) {
                    document.getElementById('edit-kid-name').value = kid.name;
                    document.getElementById('edit-kid-birthdate').value = kid.birthDate;
                    document.getElementById('edit-kid-gender').value = kid.gender;
                }
            },
            preConfirm: () => {
                const name = document.getElementById('edit-kid-name').value;
                const birthDate = document.getElementById('edit-kid-birthdate').value;
                const gender = document.getElementById('edit-kid-gender').value;

                if (!name || !birthDate || !gender) {
                    UI.error('모든 필드를 입력해주세요.');
                    return false;
                }

                return { name, birthDate, gender };
            }
        });

        if (!result.isConfirmed) {
            return;
        }

        const formValues = result.value;
        if (!formValues) {
            return;
        }

        const response = await fetch(`/api/v1/kids/${kidId}`, {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: formValues.name,
                birthDate: formValues.birthDate,
                gender: formValues.gender
            })
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            await UI.error(payload.message || '원생 정보 수정에 실패했습니다.');
            return;
        }

        await UI.success('원생 정보가 수정되었습니다.');
        await loadKids({ page: currentPage });
    }

    async function deleteKid(kidId, kidName) {
        const confirmed = await UI.confirm({
            title: '원생 삭제',
            text: `${kidName} 원생을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`,
            icon: 'warning',
            confirmButtonText: '삭제',
            cancelButtonText: '취소',
            customClass: {
                confirmButton: 'bg-red-600 hover:bg-red-700 transition-all',
                cancelButton: 'border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all'
            }
        });

        if (confirmed) {
            const response = await fetch(`/api/v1/kids/${kidId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });

            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
                await UI.error(payload.message || '원생 삭제에 실패했습니다.');
                return;
            }

            await UI.success('원생이 삭제되었습니다.');
            kidsCache = [];
            await loadKids({ refreshCounts: true, page: currentPage });
        }
    }

    async function fetchAvailableParents(currentParents) {
        const currentIds = (currentParents || []).map(parent => parent.parentId);
        const response = await fetch('/api/v1/members/parents', { credentials: 'same-origin' });
        if (!response.ok) return [];
        const payload = await response.json().catch(() => ({}));
        const parents = payload.data || [];
        return parents.filter(parent => !currentIds.includes(parent.id));
    }

    async function showParentManageModal(kidId) {
        const response = await fetch(`/api/v1/kids/${kidId}`, { credentials: 'same-origin' });

        if (!response.ok) {
            await UI.error('원생 정보를 불러오지 못했습니다.');
            return;
        }

        const result = await response.json().catch(() => ({}));
        const kidDetail = result.data;

        if (!kidDetail) {
            await UI.error('원생 정보를 찾을 수 없습니다.');
            return;
        }

        const availableParents = await fetchAvailableParents(kidDetail.parents || []);

        const parentsHtml = kidDetail.parents && kidDetail.parents.length > 0
            ? kidDetail.parents.map(p => `
                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                    <div>
                        <span class="font-medium text-gray-900">${p.parentName}</span>
                        <span class="ml-2 text-sm text-gray-600">(${p.relationship})</span>
                    </div>
                    <button type="button" onclick="removeParent(${kidId}, ${p.parentId}, '${p.parentName}')" class="text-red-600 hover:text-red-800 text-sm">
                        제거
                    </button>
                </div>
            `).join('')
            : '<div class="text-gray-500 text-center py-4">연결된 학부모가 없습니다.</div>';

        const parentOptions = availableParents.length > 0
            ? availableParents.map(parent => `<option value="${parent.id}">${parent.name}</option>`).join('')
            : '<option value="">추가 가능한 학부모가 없습니다</option>';

        window.Swal.fire({
            title: '학부모 관리',
            html: `
                <div class="text-left space-y-4">
                    <div>
                        <div class="font-semibold text-gray-900 mb-2">${kidDetail.name} 원생의 학부모</div>
                        <div id="parent-list">
                            ${parentsHtml}
                        </div>
                    </div>
                    <div class="pt-4 border-t border-gray-200">
                        <div class="font-medium text-gray-900 mb-2">학부모 추가</div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">학부모 선택 *</label>
                                <select id="parent-select" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <option value="">선택</option>
                                    ${parentOptions}
                                </select>
                                <p class="text-[11px] text-gray-500 mt-1">학부모 계정만 목록에 표시됩니다.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">관계 *</label>
                                <select id="relationship-select" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <option value="">선택</option>
                                    <option value="FATHER">아버지</option>
                                    <option value="MOTHER">어머니</option>
                                    <option value="GRANDFATHER">할아버지</option>
                                    <option value="GRANDMOTHER">할머니</option>
                                    <option value="GUARDIAN">보호자</option>
                                </select>
                            </div>
                            <button type="button" onclick="assignParent(${kidId})" class="w-full px-4 py-2 bg-gradient-primary text-white text-sm font-medium rounded-lg hover:shadow-lg transition-all">
                                학부모 추가
                            </button>
                        </div>
                    </div>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: '닫기',
            customClass: {
                popup: 'rounded-2xl',
                cancelButton: 'border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all'
            }
        });
    }

    async function assignParent(kidId) {
        const parentId = document.getElementById('parent-select').value;
        const relationship = document.getElementById('relationship-select').value;

        if (!parentId || !relationship) {
            UI.error('학부모와 관계를 선택해주세요.');
            return;
        }

        const parentSelect = document.getElementById('parent-select');
        const relationshipSelect = document.getElementById('relationship-select');

        const response = await fetch(`/api/v1/kids/${kidId}/parents`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                parentId: Number(parentId),
                relationship: relationship
            })
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            await UI.error(payload.message || '학부모 연결에 실패했습니다.');
            return;
        }

        await UI.success('학부모가 연결되었습니다.');
        if (parentSelect) parentSelect.value = '';
        if (relationshipSelect) relationshipSelect.value = '';
        await showParentManageModal(kidId);
    }

    async function removeParent(kidId, parentId, parentName) {
        const confirmed = await UI.confirm({
            title: '학부모 연결 해제',
            text: `${parentName}님의 연결을 해제하시겠습니까?`,
            icon: 'warning',
            confirmButtonText: '해제',
            cancelButtonText: '취소',
            customClass: {
                confirmButton: 'bg-red-600 hover:bg-red-700 transition-all',
                cancelButton: 'border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all'
            }
        });

        if (confirmed) {
            const response = await fetch(`/api/v1/kids/${kidId}/parents/${parentId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });

            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
                await UI.error(payload.message || '학부모 연결 해제에 실패했습니다.');
                return;
            }

            await UI.success('학부모 연결이 해제되었습니다.');
            await showParentManageModal(kidId);
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await ensureKidsCache(true);
        await loadClassrooms();
        await loadKids({ page: 1 });
    });
</script>
</body>
</html>
