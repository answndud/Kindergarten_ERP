<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>홈 - 유치원 ERP</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#edf7f1',
                            100: '#d8f0df',
                            300: '#7ec09a',
                            500: '#2d8a62',
                            700: '#1f5a41'
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" th:href="@{/css/custom.css}" href="/css/custom.css">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
<header th:replace="~{fragments/header :: header}"></header>

<main class="app-main" th:if="${currentMember != null}" x-data="dashboardStats()" x-init="init()">
    <section class="app-surface p-6 md:p-8 section-enter overflow-hidden relative">
        <div class="absolute -top-24 -right-20 w-64 h-64 rounded-full bg-primary-100/70 blur-3xl pointer-events-none"></div>
        <div class="absolute -bottom-20 -left-16 w-56 h-56 rounded-full bg-amber-100/70 blur-3xl pointer-events-none"></div>

        <div class="relative flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
            <div>
                <div class="flex items-center gap-3 mb-3">
                    <span class="w-12 h-12 rounded-xl bg-gradient-primary p-2 shadow-sm">
                        <img th:src="@{/img/logo.svg}" src="/img/logo.svg" alt="KinderCare" class="w-full h-full object-contain" />
                    </span>
                    <div>
                        <p class="text-xs uppercase tracking-[0.16em] text-gray-500">Today Brief</p>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
                            안녕하세요, <span class="text-primary-700" th:text="${currentMember.name}">사용자</span>님
                        </h1>
                    </div>
                </div>

                <p class="text-gray-600 text-sm md:text-base">운영 현황과 승인 대기 이슈를 한 화면에서 확인하세요.</p>
                <div class="mt-4 flex flex-wrap items-center gap-2">
                    <span class="stat-chip" th:text="${currentMember.role != null ? currentMember.role.title : '멤버'}">역할</span>
                    <span class="stat-chip" data-tone="accent" th:text="${currentMember.status != null ? currentMember.status.description : '상태'}">상태</span>
                    <span class="stat-chip" th:if="${currentMember.kindergartenName != null}" th:text="${currentMember.kindergartenName}">유치원</span>
                </div>
            </div>

            <div class="w-full lg:w-72 p-4 rounded-2xl bg-white/75 border border-gray-200 shadow-sm">
                <p class="text-xs text-gray-500 mb-2">측정 기간</p>
                <div class="flex gap-2">
                    <button type="button"
                            class="px-3 py-1.5 text-xs font-semibold rounded-full border"
                            :class="period === 'week' ? 'bg-primary-100 text-primary-700 border-primary-300' : 'text-gray-600 border-gray-200 hover:text-primary-700'"
                            @click="setPeriod('week')">
                        최근 7일
                    </button>
                    <button type="button"
                            class="px-3 py-1.5 text-xs font-semibold rounded-full border"
                            :class="period === 'month' ? 'bg-primary-100 text-primary-700 border-primary-300' : 'text-gray-600 border-gray-200 hover:text-primary-700'"
                            @click="setPeriod('month')">
                        최근 30일
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">기준: Asia/Seoul</p>
            </div>
        </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4 mt-5 section-enter">
        <a href="/kids" class="app-surface p-4 hover:-translate-y-0.5">
            <p class="text-xs text-gray-500">원아 관리</p>
            <div class="mt-3 flex items-end justify-between">
                <p class="text-2xl font-bold text-gray-900">이동</p>
                <span class="w-10 h-10 rounded-xl bg-pink-100 flex items-center justify-center text-pink-600">👧</span>
            </div>
        </a>

        <a href="/attendance" class="app-surface p-4 hover:-translate-y-0.5">
            <p class="text-xs text-gray-500">출석률</p>
            <div class="mt-3 flex items-end justify-between">
                <p class="text-2xl font-bold text-gray-900"><span x-text="stats.attendanceRate">0</span>%</p>
                <span class="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center text-emerald-700">✓</span>
            </div>
        </a>

        <a href="/applications/pending" class="app-surface p-4 hover:-translate-y-0.5">
            <p class="text-xs text-gray-500">승인 대기</p>
            <div class="mt-3 flex items-end justify-between">
                <p class="text-2xl font-bold text-gray-900" x-text="stats.applicationsPending">0</p>
                <span class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center text-amber-700">⏳</span>
            </div>
        </a>

        <a href="/notepad" class="app-surface p-4 hover:-translate-y-0.5">
            <p class="text-xs text-gray-500">새 알림장</p>
            <div class="mt-3 flex items-end justify-between">
                <p class="text-2xl font-bold text-gray-900" x-text="stats.notepads">0</p>
                <span class="w-10 h-10 rounded-xl bg-primary-100 flex items-center justify-center text-primary-700">📝</span>
            </div>
        </a>

        <a href="/announcements" class="app-surface p-4 hover:-translate-y-0.5">
            <p class="text-xs text-gray-500">공지사항</p>
            <div class="mt-3 flex items-end justify-between">
                <p class="text-2xl font-bold text-gray-900" x-text="stats.announcements">0</p>
                <span class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center text-blue-700">📢</span>
            </div>
        </a>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-5 gap-5 mt-5 section-enter">
        <a href="/profile" class="lg:col-span-2 app-surface p-6 hover:-translate-y-0.5">
            <h2 class="text-lg font-bold text-gray-900">내 계정 정보</h2>
            <div class="mt-4 space-y-3 text-sm">
                <div class="flex justify-between gap-4 border-b border-gray-100 pb-2">
                    <span class="text-gray-500">이메일</span>
                    <span class="font-semibold text-gray-900" th:text="${currentMember.email}">-</span>
                </div>
                <div class="flex justify-between gap-4 border-b border-gray-100 pb-2">
                    <span class="text-gray-500">이름</span>
                    <span class="font-semibold text-gray-900" th:text="${currentMember.name}">-</span>
                </div>
                <div class="flex justify-between gap-4 border-b border-gray-100 pb-2">
                    <span class="text-gray-500">역할</span>
                    <span class="font-semibold text-gray-900" th:text="${currentMember.role != null ? currentMember.role.title : '-'}">-</span>
                </div>
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">상태</span>
                    <span class="font-semibold text-gray-900" th:text="${currentMember.status != null ? currentMember.status.description : '-'}">-</span>
                </div>
            </div>
        </a>

        <div class="lg:col-span-3 app-surface p-6">
            <h2 class="text-lg font-bold text-gray-900">빠른 이동</h2>
            <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-3">
                <a href="/classrooms" class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 text-sm font-semibold text-gray-700">반 관리</a>
                <a href="/kids" class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 text-sm font-semibold text-gray-700">원생 관리</a>
                <a href="/attendance/monthly" class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 text-sm font-semibold text-gray-700">월간 리포트</a>
                <a href="/calendar" class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 text-sm font-semibold text-gray-700">일정 캘린더</a>
                <a href="/notifications" class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 text-sm font-semibold text-gray-700">알림센터</a>
                <a href="/applications/pending" class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 text-sm font-semibold text-gray-700">승인/신청</a>
            </div>
        </div>
    </section>
</main>

<main class="app-main" th:if="${currentMember == null}">
    <section class="app-surface p-8 md:p-12 section-enter">
        <p class="text-xs uppercase tracking-[0.16em] text-gray-500">Kindergarten ERP</p>
        <h1 class="mt-3 text-3xl md:text-5xl font-bold text-gray-900 leading-tight">유치원 운영을 더 단순하게</h1>
        <p class="mt-4 text-gray-600 max-w-2xl">회원가입 후 역할별 워크플로우에 맞춰 출결, 알림장, 공지, 승인 관리를 한 곳에서 처리할 수 있습니다.</p>
        <div class="mt-7 flex flex-wrap gap-3">
            <a href="/login" class="px-5 py-3 rounded-xl text-sm font-semibold bg-gradient-primary text-white">로그인</a>
            <a href="/signup" class="px-5 py-3 rounded-xl text-sm font-semibold bg-white border border-gray-200 text-gray-700 hover:bg-gray-50">회원가입</a>
        </div>
    </section>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/js/app.js}"></script>

<script>
    function dashboardStats() {
        return {
            period: 'week',
            loading: false,
            stats: {
                notepads: 0,
                attendanceRate: 0,
                applicationsPending: 0,
                announcements: 0
            },
            async init() {
                await this.loadStats();
                document.body.addEventListener('dashboard-stats-changed', () => {
                    this.loadStats();
                });
            },
            async setPeriod(value) {
                if (this.period === value || this.loading) return;
                this.period = value;
                await this.loadStats();
            },
            getRangeDays() {
                return this.period === 'month' ? 30 : 7;
            },
            getKstBaseDate(date = new Date()) {
                const formatter = new Intl.DateTimeFormat('en-CA', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                const [year, month, day] = formatter.format(date).split('-').map(Number);
                return new Date(Date.UTC(year, month - 1, day));
            },
            toDateString(date) {
                return date.toISOString().slice(0, 10);
            },
            async loadStats() {
                if (this.loading) return;
                this.loading = true;
                try {
                    const meRes = await fetch('/api/v1/members/me', { credentials: 'same-origin' });
                    if (!meRes.ok) return;
                    const me = await meRes.json().catch(() => ({}));
                    if (!me.success || !me.data || !me.data.kindergartenId) return;

                    const kindergartenId = me.data.kindergartenId;
                    const nowKst = this.getKstBaseDate();
                    const endDate = this.toDateString(nowKst);
                    const rangeDays = this.getRangeDays();
                    const startDateObj = new Date(nowKst);
                    startDateObj.setDate(startDateObj.getDate() - (rangeDays - 1));
                    const startDate = this.toDateString(startDateObj);

                    const notepadsRes = await fetch('/api/v1/notepads?page=0&size=200', { credentials: 'same-origin' });
                    if (notepadsRes.ok) {
                        const payload = await notepadsRes.json().catch(() => ({}));
                        this.stats.notepads = (payload.data?.content || []).filter(item => {
                            return item.createdAt && item.createdAt.slice(0, 10) >= startDate && item.createdAt.slice(0, 10) <= endDate;
                        }).length;
                    }

                    const classroomsRes = await fetch(`/api/v1/classrooms?kindergartenId=${kindergartenId}`, { credentials: 'same-origin' });
                    if (classroomsRes.ok) {
                        const classroomsData = await classroomsRes.json().catch(() => ({}));
                        const classrooms = classroomsData.data || [];
                        if (classrooms.length > 0) {
                            let totalPresent = 0;
                            let totalCount = 0;

                            for (let dayOffset = 0; dayOffset < rangeDays; dayOffset += 1) {
                                const date = new Date(startDateObj);
                                date.setDate(startDateObj.getDate() + dayOffset);
                                const dateStr = this.toDateString(date);

                                const responses = await Promise.all(
                                    classrooms.map(c =>
                                        fetch(`/api/v1/attendance/daily?date=${dateStr}&classroomId=${c.id}`, { credentials: 'same-origin' })
                                            .then(resp => resp.ok ? resp.json().catch(() => ({})) : null)
                                    )
                                );

                                responses.forEach((payload) => {
                                    if (!payload) return;
                                    const list = payload.data || [];
                                    if (list.length === 0) return;
                                    const present = list.filter(row => row.status === 'PRESENT' || row.status === 'LATE').length;
                                    totalPresent += present;
                                    totalCount += list.length;
                                });
                            }

                            this.stats.attendanceRate = totalCount > 0 ? Math.round((totalPresent / totalCount) * 100) : 0;
                        }
                    }

                    this.stats.applicationsPending = 0;
                    if (me.data.role === 'PRINCIPAL' || me.data.role === 'TEACHER') {
                        const kidRes = await fetch(`/api/v1/kid-applications/pending?kindergartenId=${kindergartenId}`, { credentials: 'same-origin' });
                        if (kidRes.ok) {
                            const kidData = await kidRes.json().catch(() => ({}));
                            this.stats.applicationsPending = (kidData.data || []).length;
                        }
                    }

                    if (me.data.role === 'PRINCIPAL') {
                        const teacherRes = await fetch(`/api/v1/kindergarten-applications/pending?kindergartenId=${kindergartenId}`, { credentials: 'same-origin' });
                        if (teacherRes.ok) {
                            const teacherData = await teacherRes.json().catch(() => ({}));
                            this.stats.applicationsPending += (teacherData.data || []).length;
                        }
                    }

                    const annRes = await fetch(`/api/v1/announcements?kindergartenId=${kindergartenId}&page=0&size=200`, { credentials: 'same-origin' });
                    if (annRes.ok) {
                        const payload = await annRes.json().catch(() => ({}));
                        this.stats.announcements = (payload.data?.content || []).filter(item => {
                            return item.createdAt && item.createdAt.slice(0, 10) >= startDate && item.createdAt.slice(0, 10) <= endDate;
                        }).length;
                    }
                } catch (error) {
                    console.error('대시보드 통계 로드 실패:', error);
                } finally {
                    this.loading = false;
                }
            }
        };
    }
</script>
</body>
</html>
