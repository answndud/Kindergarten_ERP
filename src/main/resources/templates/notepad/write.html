<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>알림장 작성 - 유치원 ERP</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#F3FBF7',
                            100: '#E2F5EB',
                            200: '#C7EBD9',
                            300: '#A4DEC2',
                            400: '#79CCA5',
                            500: '#56B88C',
                            600: '#3F9C73',
                            700: '#327D5E',
                            800: '#26624A',
                            900: '#1D4D3A',
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .bg-gradient-primary { background: linear-gradient(135deg, #56B88C 0%, #3F9C73 100%); }
    </style>
    <link rel="stylesheet" th:href="@{/css/custom.css}" href="/css/custom.css">
</head>
<body class="bg-gray-50">

<header th:replace="~{fragments/header :: header}"></header>

<main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <a href="/notepad" class="inline-flex items-center gap-2 text-gray-600 hover:text-primary-600 mb-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            목록으로
        </a>
        <h1 class="text-2xl font-bold text-gray-900">알림장 작성</h1>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200">
        <form th:action="@{/notepad}" method="post" class="p-6 space-y-6">
            <div class="grid gap-4">
                <div>
                    <label for="targetType" class="block text-sm font-medium text-gray-700 mb-1">발송 대상</label>
                    <select id="targetType" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="GLOBAL">전체 학부모</option>
                        <option value="CLASSROOM">특정 반</option>
                        <option value="KID">개별 원생</option>
                    </select>
                </div>

                <div>
                    <label for="classroomId" class="block text-sm font-medium text-gray-700 mb-1">반 선택</label>
                    <select id="classroomId" name="classroomId"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">전체</option>
                    </select>
                </div>

                <div>
                    <label for="kidId" class="block text-sm font-medium text-gray-700 mb-1">원생 선택</label>
                    <select id="kidId" name="kidId"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" disabled>
                        <option value="">원생 선택</option>
                    </select>
                </div>

                <div class="text-xs text-gray-500" id="targetSummary">전체 학부모에게 알림이 발송됩니다.</div>
            </div>

            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">제목 *</label>
                <input type="text" name="title" id="title" required
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                       placeholder="알림장 제목을 입력하세요" />
            </div>

            <div>
                <label for="content" class="block text-sm font-medium text-gray-700 mb-1">내용 *</label>
                <textarea name="content" id="content" required rows="10"
                          class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 resize-y"
                          placeholder="알림장 내용을 입력하세요..."></textarea>
            </div>

            <div>
                <label for="photoUrl" class="block text-sm font-medium text-gray-700 mb-1">사진 URL (선택)</label>
                <input type="text" name="photoUrl" id="photoUrl"
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                       placeholder="콤마로 구분하여 여러 장을 등록할 수 있습니다" />
            </div>

            <div class="flex gap-3 pt-4 border-t border-gray-200">
                <button type="submit" class="flex-1 px-4 py-2 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors">
                    작성하기
                </button>
                <button type="button" onclick="history.back()" class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    취소
                </button>
            </div>
        </form>
    </div>
</main>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/js/app.js}"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', async function() {
        const targetType = document.getElementById('targetType');
        const classroomSelect = document.getElementById('classroomId');
        const kidSelect = document.getElementById('kidId');
        const targetSummary = document.getElementById('targetSummary');

        let kindergartenId = /*[[${currentMember?.kindergartenId}]]*/ null;

        const fetchList = async (url) => {
            const response = await fetch(url, { credentials: 'same-origin' });
            if (!response.ok) return [];
            const result = await response.json().catch(() => ({}));
            return result.data || [];
        };

        const ensureKindergartenId = async () => {
            if (kindergartenId) return kindergartenId;
            const response = await fetch('/api/v1/members/me', { credentials: 'same-origin' });
            if (!response.ok) return null;
            const result = await response.json().catch(() => ({}));
            kindergartenId = result?.data?.kindergartenId || null;
            return kindergartenId;
        };

        const setOptions = (select, placeholderLabel, items) => {
            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = placeholderLabel;
            select.appendChild(placeholder);

            (items || []).forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                select.appendChild(option);
            });
        };

        const loadClassrooms = async () => {
            const id = await ensureKindergartenId();
            if (!id) return [];
            return fetchList(`/api/v1/classrooms?kindergartenId=${id}`);
        };

        const loadKidsByClassroom = async (classroomId) => {
            if (!classroomId) return [];
            return fetchList(`/api/v1/kids?classroomId=${classroomId}`);
        };

        const updateTargetSummary = () => {
            const type = targetType.value;
            if (type === 'GLOBAL') {
                targetSummary.textContent = '전체 학부모에게 알림이 발송됩니다.';
            } else if (type === 'CLASSROOM') {
                const selected = classroomSelect.options[classroomSelect.selectedIndex];
                targetSummary.textContent = selected && selected.value
                    ? `${selected.textContent} 반 학부모에게 발송됩니다.`
                    : '반을 선택하면 해당 반 학부모에게 발송됩니다.';
            } else {
                const selected = kidSelect.options[kidSelect.selectedIndex];
                targetSummary.textContent = selected && selected.value
                    ? `${selected.textContent} 학부모에게 발송됩니다.`
                    : '원생을 선택하면 해당 원생 학부모에게 발송됩니다.';
            }
        };

        const updateTargetInputs = () => {
            const type = targetType.value;
            if (type === 'GLOBAL') {
                classroomSelect.disabled = true;
                kidSelect.disabled = true;
                classroomSelect.value = '';
                kidSelect.value = '';
            } else if (type === 'CLASSROOM') {
                classroomSelect.disabled = false;
                kidSelect.disabled = true;
                kidSelect.value = '';
            } else {
                classroomSelect.disabled = false;
                kidSelect.disabled = false;
            }
            updateTargetSummary();
        };

        try {
            const classrooms = await loadClassrooms();
            setOptions(classroomSelect, classrooms.length ? '반을 선택하세요' : '등록된 반이 없습니다', classrooms);
        } catch (error) {
            console.error('반 목록 로드 실패:', error);
        }

        targetType.addEventListener('change', updateTargetInputs);
        classroomSelect.addEventListener('change', async () => {
            const kids = await loadKidsByClassroom(classroomSelect.value);
            setOptions(kidSelect, kids.length ? '원생을 선택하세요' : '등록된 원생이 없습니다', kids);
            updateTargetInputs();
        });
        kidSelect.addEventListener('change', updateTargetSummary);

        updateTargetInputs();
    });
</script>
</body>
</html>
