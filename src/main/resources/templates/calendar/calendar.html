<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일정/캘린더 - 유치원 ERP</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .bg-gradient-primary { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
    </style>
</head>
<body class="bg-gray-50">

<header th:replace="~{fragments/header :: header}"></header>

<main class="relative">
    <div class="absolute inset-0 pointer-events-none overflow-hidden">
        <div class="absolute -top-24 -right-24 w-72 h-72 bg-primary-100 rounded-full blur-3xl opacity-70"></div>
        <div class="absolute top-40 -left-20 w-72 h-72 bg-emerald-100 rounded-full blur-3xl opacity-60"></div>
    </div>

    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-8">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">일정/캘린더</h1>
                <p class="text-gray-600">유치원, 반, 개인 일정을 한곳에서 관리하세요</p>
            </div>
            <button id="createEventBtn"
                    class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-gradient-primary text-white font-semibold shadow-lg hover:shadow-xl transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                새 일정
            </button>
        </div>

        <div class="bg-white/90 backdrop-blur rounded-2xl shadow-sm border border-gray-200 p-5 mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                <div class="lg:col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-2">조회 기간</label>
                    <div class="flex gap-2">
                        <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2">범위</label>
                    <select id="scopeType" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="">전체</option>
                        <option th:each="scope : ${scopeTypes}" th:value="${scope.name()}" th:text="${scope.name()}"></option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-2">반</label>
                    <select id="classroomId" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" disabled>
                        <option value="">전체</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="todayBtn" class="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700 hover:bg-gray-50">오늘</button>
                </div>
            </div>
        </div>

        <div id="calendar-list"
             hx-get="/calendar/list"
             hx-trigger="load, calendar-filters-changed from:body"
             hx-include="#startDate,#endDate,#scopeType,#classroomId"
             hx-swap="outerHTML"
             class="space-y-4">
            <div class="flex justify-center items-center py-16">
                <svg class="animate-spin h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>
</main>

<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<!-- Alpine.js -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Custom JS -->
<script th:src="@{/js/app.js}"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', async () => {
        const role = /*[[${currentMember?.role?.name()}]]*/ null;
        const memberId = /*[[${currentMember?.id}]]*/ null;
        let kindergartenId = /*[[${currentMember?.kindergartenId}]]*/ null;

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const scopeSelect = document.getElementById('scopeType');
        const classroomSelect = document.getElementById('classroomId');
        const todayBtn = document.getElementById('todayBtn');
        const createEventBtn = document.getElementById('createEventBtn');

        const toDateString = (date) => date.toISOString().split('T')[0];

        const setDefaultRange = () => {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            startDateInput.value = toDateString(start);
            endDateInput.value = toDateString(end);
        };

        const triggerReload = () => {
            if (window.htmx) {
                htmx.trigger(document.body, 'calendar-filters-changed');
            }
        };

        const fetchJson = async (url) => {
            const response = await fetch(url, { credentials: 'same-origin' });
            if (!response.ok) return null;
            return response.json().catch(() => null);
        };

        const ensureKindergartenId = async () => {
            if (kindergartenId) return kindergartenId;
            const me = await fetchJson('/api/v1/members/me');
            if (me && me.data && me.data.kindergartenId) {
                kindergartenId = me.data.kindergartenId;
            }
            return kindergartenId;
        };

        const loadClassrooms = async () => {
            if (role === 'PARENT') {
                const res = await fetchJson('/api/v1/kids/my-kids');
                const kids = res && res.data ? res.data : [];
                const unique = new Map();
                kids.forEach(kid => {
                    if (kid.classroomId && !unique.has(kid.classroomId)) {
                        unique.set(kid.classroomId, { id: kid.classroomId, name: kid.classroomName });
                    }
                });
                return Array.from(unique.values());
            }

            const id = await ensureKindergartenId();
            if (!id) return [];
            const res = await fetchJson(`/api/v1/classrooms?kindergartenId=${id}`);
            const classrooms = res && res.data ? res.data : [];

            if (role === 'TEACHER' && memberId) {
                return classrooms.filter(c => c.teacherId === memberId);
            }
            return classrooms;
        };

        const populateClassrooms = async () => {
            const classrooms = await loadClassrooms();
            classroomSelect.innerHTML = '<option value="">전체</option>';
            classrooms.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                classroomSelect.appendChild(opt);
            });
            classroomSelect.disabled = scopeSelect.value !== 'CLASSROOM';
        };

        const updateScopeOptions = () => {
            const options = Array.from(scopeSelect.options);
            options.forEach(option => {
                if (option.value === 'KINDERGARTEN' && role === 'PARENT') {
                    option.remove();
                }
            });
        };

        const normalizeScopeForCreate = (scope) => {
            if (role === 'PARENT') {
                return 'PERSONAL';
            }
            if (role === 'TEACHER' && scope === 'KINDERGARTEN') {
                return 'CLASSROOM';
            }
            return scope;
        };

        setDefaultRange();
        updateScopeOptions();
        await populateClassrooms();
        triggerReload();

        scopeSelect.addEventListener('change', async () => {
            classroomSelect.disabled = scopeSelect.value !== 'CLASSROOM';
            if (scopeSelect.value !== 'CLASSROOM') {
                classroomSelect.value = '';
            }
            triggerReload();
        });

        startDateInput.addEventListener('change', triggerReload);
        endDateInput.addEventListener('change', triggerReload);
        classroomSelect.addEventListener('change', triggerReload);

        todayBtn.addEventListener('click', () => {
            const today = new Date();
            startDateInput.value = toDateString(today);
            endDateInput.value = toDateString(today);
            triggerReload();
        });

        createEventBtn.addEventListener('click', async () => {
            const classrooms = await loadClassrooms();
            const scopeOptions = [];

            if (role === 'PRINCIPAL') {
                scopeOptions.push({ value: 'KINDERGARTEN', label: '유치원 전체' });
                scopeOptions.push({ value: 'PERSONAL', label: '개인' });
            } else if (role === 'TEACHER') {
                scopeOptions.push({ value: 'CLASSROOM', label: '반' });
                scopeOptions.push({ value: 'PERSONAL', label: '개인' });
            } else {
                scopeOptions.push({ value: 'PERSONAL', label: '개인' });
            }

            const eventTypeOptions = [
                { value: 'LESSON', label: '수업' },
                { value: 'EVENT', label: '행사' },
                { value: 'HOLIDAY', label: '휴일' },
                { value: 'MEETING', label: '회의' },
                { value: 'EXAM', label: '평가' },
                { value: 'FIELD_TRIP', label: '현장학습' },
                { value: 'ETC', label: '기타' }
            ];

            const repeatOptions = [
                { value: 'NONE', label: '반복 없음' },
                { value: 'DAILY', label: '매일' },
                { value: 'WEEKLY', label: '매주' },
                { value: 'MONTHLY', label: '매월' }
            ];

            const classroomOptionsHtml = classrooms.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const scopeOptionsHtml = scopeOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
            const eventTypeHtml = eventTypeOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
            const repeatTypeHtml = repeatOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('');

            const result = await Swal.fire({
                title: '새 일정 등록',
                html: `
                    <div class="text-left space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">범위</label>
                            <select id="swal-scope" class="w-full px-3 py-2 border border-gray-200 rounded-lg">${scopeOptionsHtml}</select>
                        </div>
                        <div id="swal-classroom-wrap" class="hidden">
                            <label class="block text-xs font-semibold text-gray-600 mb-1">반 선택</label>
                            <select id="swal-classroom" class="w-full px-3 py-2 border border-gray-200 rounded-lg">${classroomOptionsHtml}</select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">일정 유형</label>
                            <select id="swal-event-type" class="w-full px-3 py-2 border border-gray-200 rounded-lg">${eventTypeHtml}</select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">제목</label>
                            <input id="swal-title" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="예) 봄소풍" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">시작</label>
                            <input id="swal-start" type="datetime-local" class="w-full px-3 py-2 border border-gray-200 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">종료</label>
                            <input id="swal-end" type="datetime-local" class="w-full px-3 py-2 border border-gray-200 rounded-lg" />
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="swal-all-day" type="checkbox" class="rounded" />
                            <label for="swal-all-day" class="text-sm text-gray-700">종일 일정</label>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">장소</label>
                            <input id="swal-location" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="예) 운동장" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">반복</label>
                            <select id="swal-repeat" class="w-full px-3 py-2 border border-gray-200 rounded-lg">${repeatTypeHtml}</select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">반복 종료일</label>
                            <input id="swal-repeat-end" type="date" class="w-full px-3 py-2 border border-gray-200 rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">설명</label>
                            <textarea id="swal-description" rows="4" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="일정 설명을 입력하세요."></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '등록',
                cancelButtonText: '취소',
                customClass: {
                    popup: 'rounded-2xl',
                    confirmButton: 'px-4 py-2 rounded-lg bg-primary-600 text-white font-medium',
                    cancelButton: 'px-4 py-2 rounded-lg bg-gray-100 text-gray-700 font-medium'
                },
                buttonsStyling: false,
                didOpen: () => {
                    const scopeEl = document.getElementById('swal-scope');
                    const classroomWrap = document.getElementById('swal-classroom-wrap');
                    const toggleClassroom = () => {
                        classroomWrap.classList.toggle('hidden', scopeEl.value !== 'CLASSROOM');
                    };
                    scopeEl.addEventListener('change', toggleClassroom);
                    toggleClassroom();
                },
                preConfirm: () => {
                    const scope = normalizeScopeForCreate(document.getElementById('swal-scope').value);
                    const classroomIdValue = document.getElementById('swal-classroom').value;
                    const title = document.getElementById('swal-title').value;
                    const start = document.getElementById('swal-start').value;
                    const end = document.getElementById('swal-end').value;
                    const eventType = document.getElementById('swal-event-type').value;
                    const isAllDay = document.getElementById('swal-all-day').checked;
                    const location = document.getElementById('swal-location').value;
                    const repeatType = document.getElementById('swal-repeat').value;
                    const repeatEndDate = document.getElementById('swal-repeat-end').value;
                    const description = document.getElementById('swal-description').value;

                    if (!title || title.trim() === '') {
                        Swal.showValidationMessage('제목을 입력해 주세요.');
                        return false;
                    }
                    if (!start || !end) {
                        Swal.showValidationMessage('시작/종료 일시는 필수입니다.');
                        return false;
                    }
                    if (scope === 'CLASSROOM' && !classroomIdValue) {
                        Swal.showValidationMessage('반을 선택해 주세요.');
                        return false;
                    }

                    return {
                        scopeType: scope,
                        classroomId: scope === 'CLASSROOM' ? Number(classroomIdValue) : null,
                        title: title.trim(),
                        description: description ? description.trim() : null,
                        startDateTime: start,
                        endDateTime: end,
                        eventType: eventType,
                        isAllDay: isAllDay,
                        location: location ? location.trim() : null,
                        repeatType: repeatType,
                        repeatEndDate: repeatEndDate || null
                    };
                }
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch('/api/v1/calendar/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(result.value)
                });
                const payload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(payload.message || '일정 등록에 실패했습니다.');
                }
                await UI.success('일정을 등록했습니다.');
                triggerReload();
            } catch (error) {
                await UI.error(error.message || '요청 처리 중 오류가 발생했습니다.');
            }
        });
    });
</script>
</body>
</html>
